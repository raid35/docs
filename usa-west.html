package com.example.s

import android.annotation.SuppressLint
import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.webkit.WebChromeClient
import android.webkit.WebSettings
import android.webkit.WebView
import android.webkit.WebViewClient
import androidx.appcompat.app.AppCompatActivity

class WebViewActivity : AppCompatActivity() {

    private lateinit var webView: WebView

    @SuppressLint("SetJavaScriptEnabled")
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        webView = WebView(this)

        val webSettings: WebSettings = webView.settings
        webSettings.javaScriptEnabled = true
        webSettings.mediaPlaybackRequiresUserGesture = false
        webSettings.domStorageEnabled = true
        webSettings.loadsImagesAutomatically = true
        webSettings.useWideViewPort = true
        webSettings.javaScriptCanOpenWindowsAutomatically = true
        webSettings.allowFileAccess = true
        webSettings.allowContentAccess = true
        webSettings.cacheMode = WebSettings.LOAD_DEFAULT
        webSettings.mixedContentMode = WebSettings.MIXED_CONTENT_ALWAYS_ALLOW

        webView.webChromeClient = WebChromeClient()

        // إعداد الـ headers العامة
        val headers = mapOf(
            "User-Agent" to "Mozilla/5.0 (Linux; Android ${android.os.Build.VERSION.RELEASE}) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36",
            "Referer" to "https://example.com/",
            "Origin" to "https://example.com/"
        )

        webView.webViewClient = object : WebViewClient() {

            override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                url ?: return false

                return when {
                    url.startsWith("https://play/stream") -> {
                        val uri = Uri.parse(url)
                        val streamUrl = uri.getQueryParameter("url")
                        val channelName = uri.getQueryParameter("name") ?: "Live Channel"

                        if (!streamUrl.isNullOrEmpty()) {
                            val intent = Intent(this@WebViewActivity, PlayerActivity::class.java).apply {
                                putExtra("streamUrl", streamUrl)
                                putExtra("channelName", channelName)
                            }
                            startActivity(intent)
                        }
                        true
                    }

                    url.startsWith("intent://") ||
                            url.startsWith("xmtv://") ||
                            url.startsWith("vlc://") ||
                            url.startsWith("ssiptv://") -> {

                        val streamUrl = convertCustomSchemeToStream(url)
                        val drmLicense = extractDrmLicense(url)

                        if (streamUrl != null) {
                            val intent = Intent(this@WebViewActivity, PlayerActivity::class.java).apply {
                                putExtra("streamUrl", streamUrl)
                                putExtra("channelName", "Live Stream")
                                putExtra("drmLicense", drmLicense)
                            }
                            startActivity(intent)
                        }
                        true
                    }

                    else -> {
                        // تحويل روابط يوتيوب إلى embed مع autoplay
                        val finalUrl = if (url.contains("youtube.com/watch")) {
                            val uri = Uri.parse(url)
                            val videoId = uri.getQueryParameter("v")
                            "https://www.youtube.com/embed/$videoId?autoplay=1"
                        } else {
                            url
                        }

                        // تحميل الرابط مع headers
                        view?.loadUrl(finalUrl, headers)
                        true
                    }
                }
            }

            override fun onPageFinished(view: WebView?, url: String?) {
                view?.evaluateJavascript(
                    """
                    (function() {
                        try {
                            var videos = document.getElementsByTagName('video');
                            if (videos.length > 0) {
                                videos[0].muted = false;
                                videos[0].autoplay = true;
                                videos[0].play();
                            }

                            var fbPlayer = document.querySelector('[data-sigil*="inlineVideo"]');
                            if (fbPlayer) {
                                fbPlayer.click();
                            }

                            if (window.location.hostname.includes('youtube.com')) {
                                var ytVideo = document.querySelector('video');
                                if (ytVideo) {
                                    ytVideo.muted = false;
                                    ytVideo.play();
                                }
                            }
                        } catch(e) {}
                    })();
                    """.trimIndent(), null
                )
            }
        }

        val url = intent.getStringExtra("url") ?: ""
        webView.loadUrl(url, headers)

        setContentView(webView)
    }

    override fun onBackPressed() {
        // أرسل أمر جافاسكريبت للصفحة لتنفيذ goBack إذا زر الرجوع ظاهر
        webView.evaluateJavascript(
            """
            (function(){
                if(document.getElementById('backButton') && document.getElementById('backButton').style.display === 'block'){
                    goBack();
                    true;
                }else{
                    false;
                }
            })();
            """.trimIndent()
        ) { result ->
            // إذا لم يتم الرجوع داخل الصفحة، نفذ الرجوع الافتراضي
            if (result == "false") {
                super.onBackPressed()
            }
        }
    }

    private fun convertCustomSchemeToStream(customUrl: String): String? {
        return try {
            when {
                customUrl.startsWith("intent://") -> {
                    val uri = Uri.parse(customUrl)
                    uri.getQueryParameter("url")
                        ?: customUrl.replace("intent://", "http://").substringBefore("#Intent")
                }

                customUrl.startsWith("xmtv://") ||
                        customUrl.startsWith("vlc://") ||
                        customUrl.startsWith("ssiptv://") -> {
                    customUrl.replaceFirst(Regex("^[a-z]+://"), "http://")
                }

                else -> null
            }
        } catch (e: Exception) {
            null
        }
    }

    private fun extractDrmLicense(url: String): String {
        return try {
            if (url.contains("license_key=")) {
                val uri = Uri.parse(url)
                uri.getQueryParameter("license_key") ?: ""
            } else {
                ""
            }
        } catch (e: Exception) {
            ""
        }
    }
}
