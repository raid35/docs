<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشغل الأفلام</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      background: linear-gradient(-45deg, #1e3c72, #2a5298, #000000, #3b1d56);
      background-size: 400% 400%;
      animation: gradientAnimation 10s ease infinite;
      color: white;
      margin: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .sidebar {
      width: 300px;
      background: rgba(30, 30, 30, 0.9);
      padding: 15px;
      overflow-y: auto;
      border-right: 3px solid #333;
    }
    .category, .movie-item {
      background: #e91e63; /* لون مختلف قليلاً للأفلام لتغيير الجو */
      padding: 15px;
      margin: 8px 0;
      border-radius: 8px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    .movie-item {
      background: rgba(255, 255, 255, 0.15);
    }
    .category:focus, .movie-item:focus {
      background: rgba(255, 255, 255, 0.3);
      outline: 3px solid #00e5ff;
      transform: scale(1.05);
    }
    .content-container {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      padding: 20px;
      overflow-y: auto;
      justify-content: center;
    }
    .content-container img {
      width: 100%;
      height: 220px; /* طول الأفلام عادة يكون أكبر (Portrait) */
      object-fit: cover;
      border-radius: 8px;
      background-color: #222;
    }
  </style>
  <script>
    const serverUrl = "http://arox.cc:80";
    const username = "24232295398641";
    const password = "24232295398641";
    
    let categories = [];
    let currentState = "CATEGORIES"; 
    let lastCategoryId = null;
    let lastCategoryIndex = null;

    // جلب فئات الأفلام
    async function loadCategories() {
      try {
        let response = await fetch(`${serverUrl}/player_api.php?username=${username}&password=${password}&action=get_vod_categories`);
        categories = await response.json();
        showCategoriesView();
      } catch (error) {
        document.getElementById("categories").innerHTML = "⚠️ خطأ في تحميل فئات الأفلام";
      }
    }

    function showCategoriesView() {
      currentState = "CATEGORIES";
      document.getElementById("categories").style.display = "block";
      document.getElementById("content").innerHTML = "";
      
      let container = document.getElementById("categories");
      container.innerHTML = "";
      categories.forEach((category, idx) => {
        let div = document.createElement("div");
        div.className = "category";
        div.innerText = category.category_name;
        div.tabIndex = 0;
        div.onclick = () => loadMovies(category.category_id, idx);
        container.appendChild(div);
      });

      setTimeout(() => {
        let cats = document.querySelectorAll(".category");
        if (lastCategoryIndex !== null && cats[lastCategoryIndex]) {
          cats[lastCategoryIndex].focus();
        } else {
          cats[0]?.focus();
        }
      }, 100);
    }

    // جلب الأفلام التابعة للفئة
    async function loadMovies(categoryId, idx, pushState = true) {
      if (pushState) history.pushState({view: "MOVIES", catId: categoryId, catIdx: idx}, "");
      
      currentState = "MOVIES";
      lastCategoryId = categoryId;
      lastCategoryIndex = idx;
      
      document.getElementById("categories").style.display = "none";

      try {
        let response = await fetch(`${serverUrl}/player_api.php?username=${username}&password=${password}&action=get_vod_streams&category_id=${categoryId}`);
        let movies = await response.json();
        displayMovies(movies);
      } catch (error) {
        document.getElementById("content").innerHTML = "⚠️ خطأ في تحميل قائمة الأفلام";
      }
    }

    function displayMovies(movies) {
      let container = document.getElementById("content");
      container.innerHTML = "";
      movies.forEach(movie => {
        let div = document.createElement("div");
        div.className = "movie-item";
        div.tabIndex = 0;
        div.onclick = () => playMovie(movie);
        div.innerHTML = `
          <img src="${movie.stream_icon}" onerror="this.src='https://via.placeholder.com/200x300?text=Movie'">
          <div style="margin-top:8px; font-size:14px;">${movie.name}</div>
        `;
        container.appendChild(div);
      });
      setTimeout(() => container.firstChild?.focus(), 100);
    }

    // تشغيل الفيلم
    function playMovie(movie) {
      const streamUrl = `${serverUrl}/movie/${username}/${password}/${movie.stream_id}.${movie.container_extension}`;
      const title = encodeURIComponent(movie.name);
      window.location.href = `intent:${streamUrl}#Intent;action=android.intent.action.VIEW;package=com.example.siksa;type=video/*;S.title=${title};end`;
    }

    // نظام الرجوع
    window.onpopstate = function(event) {
      if (event.state) {
        if (event.state.view === "CATEGORIES") showCategoriesView();
        else if (event.state.view === "MOVIES") loadMovies(event.state.catId, event.state.catIdx, false);
      } else {
        showCategoriesView();
      }
    };

    document.addEventListener("keydown", function(e) {
      const backKeys = [8, 27, 10009]; 
      if (backKeys.includes(e.keyCode) || e.key === "Backspace") {
        if (currentState !== "CATEGORIES") {
          e.preventDefault();
          history.back();
        }
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      history.replaceState({view: "CATEGORIES"}, "");
      loadCategories();
    });
  </script>
</head>
<body>
  <div class="sidebar" id="categories"></div>
  <div class="content-container" id="content"></div>
</body>
</html>
