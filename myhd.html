"use client"

import { useState, useEffect } from "react"

interface Server {
  id: string
  name: string
  url: string
  macAddress: string
}

interface Category {
  category_id: string
  category_name: string
}

interface Stream {
  stream_id: string
  name: string
  stream_icon: string
}

export default function IPTVMacLoader() {
  const [servers, setServers] = useState<Server[]>([])
  const [currentServer, setCurrentServer] = useState<Server | null>(null)
  const [categories, setCategories] = useState<Category[]>([])
  const [streams, setStreams] = useState<Stream[]>([])
  const [currentView, setCurrentView] = useState<"servers" | "categories" | "streams">("servers")
  const [selectedCategory, setSelectedCategory] = useState<Category | null>(null)
  const [showAddForm, setShowAddForm] = useState(false)
  const [loading, setLoading] = useState(false)

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
  useEffect(() => {
    const savedServers = localStorage.getItem("mac-servers")
    if (savedServers) {
      setServers(JSON.parse(savedServers))
    } else {
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø«Ø§Ù„
      const exampleServer: Server = {
        id: "example",
        name: "Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø«Ø§Ù„",
        url: "http://star4k.me:80",
        macAddress: "00:1A:79:ae:1b:b4",
      }
      setServers([exampleServer])
      localStorage.setItem("mac-servers", JSON.stringify([exampleServer]))
    }
  }, [])

  const addServer = (name: string, url: string, macAddress: string) => {
    const newServer: Server = {
      id: Date.now().toString(),
      name,
      url,
      macAddress,
    }
    const updatedServers = [...servers, newServer]
    setServers(updatedServers)
    localStorage.setItem("mac-servers", JSON.stringify(updatedServers))
    setShowAddForm(false)
  }

  const deleteServer = (serverId: string) => {
    const updatedServers = servers.filter((s) => s.id !== serverId)
    setServers(updatedServers)
    localStorage.setItem("mac-servers", JSON.stringify(updatedServers))
  }

  const loadCategories = async (server: Server) => {
    setLoading(true)
    setCurrentServer(server)
    try {
      const response = await fetch(`${server.url}/player_api.php?action=get_live_categories&mac=${server.macAddress}`)
      const data = await response.json()
      setCategories(data)
      setCurrentView("categories")
    } catch (error) {
      alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª")
    }
    setLoading(false)
  }

  const loadStreams = async (category: Category) => {
    if (!currentServer) return

    setLoading(true)
    setSelectedCategory(category)
    try {
      const response = await fetch(
        `${currentServer.url}/player_api.php?action=get_live_streams&category_id=${category.category_id}&mac=${currentServer.macAddress}`,
      )
      const data = await response.json()
      setStreams(data)
      setCurrentView("streams")
    } catch (error) {
      alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª")
    }
    setLoading(false)
  }

  const playStream = (streamId: string) => {
    if (!currentServer) return

    const streamUrl = `${currentServer.url}/live/${currentServer.macAddress}/${streamId}.m3u8`
    const channelName = encodeURIComponent("Live Channel")
    window.location.href = `https://play/stream?url=${encodeURIComponent(streamUrl)}&name=${channelName}`
  }

  const goBack = () => {
    if (currentView === "streams") {
      setCurrentView("categories")
    } else if (currentView === "categories") {
      setCurrentView("servers")
      setCurrentServer(null)
    }
  }

  return (
    <div
      style={{
        fontFamily: "Arial, sans-serif",
        direction: "rtl",
        background: "linear-gradient(-45deg, #1e3c72, #2a5298, #000000, #3b1d56)",
        backgroundSize: "400% 400%",
        animation: "gradientAnimation 10s ease infinite",
        color: "white",
        margin: 0,
        minHeight: "100vh",
        overflow: "hidden",
      }}
    >
      {/* Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª */}
      {currentView === "servers" && (
        <div style={{ padding: "20px" }}>
          <div
            style={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
              marginBottom: "30px",
            }}
          >
            <h1 style={{ fontSize: "28px", margin: 0 }}>ğŸ”¥ Ù…Ø´ØºÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
            <button
              onClick={() => setShowAddForm(!showAddForm)}
              style={{
                background: "#ff5722",
                border: "none",
                padding: "12px 20px",
                borderRadius: "8px",
                color: "white",
                fontSize: "16px",
                cursor: "pointer",
                fontWeight: "bold",
              }}
            >
              {showAddForm ? "Ø¥Ù„ØºØ§Ø¡" : "â• Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ±ÙØ±"}
            </button>
          </div>

          {/* Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ±ÙØ± */}
          {showAddForm && (
            <div
              style={{
                background: "rgba(30, 30, 30, 0.9)",
                padding: "20px",
                borderRadius: "12px",
                marginBottom: "20px",
                border: "2px solid #ff5722",
              }}
            >
              <h3 style={{ marginTop: 0, color: "#ff5722" }}>Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ±ÙØ± Ø¬Ø¯ÙŠØ¯</h3>
              <form
                onSubmit={(e) => {
                  e.preventDefault()
                  const formData = new FormData(e.target as HTMLFormElement)
                  addServer(
                    formData.get("name") as string,
                    formData.get("url") as string,
                    formData.get("mac") as string,
                  )
                }}
              >
                <div style={{ marginBottom: "15px" }}>
                  <label style={{ display: "block", marginBottom: "5px" }}>Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±:</label>
                  <input
                    name="name"
                    required
                    style={{
                      width: "100%",
                      padding: "10px",
                      borderRadius: "6px",
                      border: "1px solid #555",
                      background: "#333",
                      color: "white",
                      fontSize: "16px",
                    }}
                    placeholder="Ù…Ø«Ø§Ù„: Ø³ÙŠØ±ÙØ± Ø§Ù„Ø±ÙŠØ§Ø¶Ø©"
                  />
                </div>
                <div style={{ marginBottom: "15px" }}>
                  <label style={{ display: "block", marginBottom: "5px" }}>Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ±:</label>
                  <input
                    name="url"
                    required
                    style={{
                      width: "100%",
                      padding: "10px",
                      borderRadius: "6px",
                      border: "1px solid #555",
                      background: "#333",
                      color: "white",
                      fontSize: "16px",
                    }}
                    placeholder="http://example.com:80"
                  />
                </div>
                <div style={{ marginBottom: "15px" }}>
                  <label style={{ display: "block", marginBottom: "5px" }}>MAC Address:</label>
                  <input
                    name="mac"
                    required
                    style={{
                      width: "100%",
                      padding: "10px",
                      borderRadius: "6px",
                      border: "1px solid #555",
                      background: "#333",
                      color: "white",
                      fontSize: "16px",
                    }}
                    placeholder="00:1A:79:ae:1b:b4"
                  />
                </div>
                <button
                  type="submit"
                  style={{
                    background: "#4CAF50",
                    border: "none",
                    padding: "12px 24px",
                    borderRadius: "6px",
                    color: "white",
                    fontSize: "16px",
                    cursor: "pointer",
                    fontWeight: "bold",
                  }}
                >
                  âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙŠØ±ÙØ±
                </button>
              </form>
            </div>
          )}

          {/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª */}
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "repeat(auto-fit, minmax(300px, 1fr))",
              gap: "20px",
            }}
          >
            {servers.map((server) => (
              <div
                key={server.id}
                style={{
                  background: "rgba(255, 255, 255, 0.1)",
                  padding: "20px",
                  borderRadius: "12px",
                  border: "2px solid transparent",
                  transition: "0.3s",
                  cursor: "pointer",
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.border = "2px solid #ff5722"
                  e.currentTarget.style.transform = "scale(1.05)"
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.border = "2px solid transparent"
                  e.currentTarget.style.transform = "scale(1)"
                }}
              >
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                  <div>
                    <h3 style={{ margin: "0 0 10px 0", color: "#ff5722", fontSize: "20px" }}>ğŸ“¡ {server.name}</h3>
                    <p style={{ margin: "5px 0", fontSize: "14px", opacity: 0.8 }}>ğŸŒ {server.url}</p>
                    <p style={{ margin: "5px 0", fontSize: "14px", opacity: 0.8 }}>ğŸ”§ {server.macAddress}</p>
                  </div>
                  <button
                    onClick={(e) => {
                      e.stopPropagation()
                      deleteServer(server.id)
                    }}
                    style={{
                      background: "#f44336",
                      border: "none",
                      padding: "8px 12px",
                      borderRadius: "6px",
                      color: "white",
                      fontSize: "12px",
                      cursor: "pointer",
                    }}
                  >
                    ğŸ—‘ï¸ Ø­Ø°Ù
                  </button>
                </div>
                <button
                  onClick={() => loadCategories(server)}
                  disabled={loading}
                  style={{
                    background: "#ff5722",
                    border: "none",
                    padding: "12px 20px",
                    borderRadius: "8px",
                    color: "white",
                    fontSize: "16px",
                    cursor: "pointer",
                    fontWeight: "bold",
                    width: "100%",
                    marginTop: "15px",
                    opacity: loading ? 0.6 : 1,
                  }}
                >
                  {loading ? "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„..." : "ğŸš€ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"}
                </button>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª */}
      {currentView === "categories" && (
        <div style={{ display: "flex", height: "100vh" }}>
          <div
            style={{
              width: "300px",
              background: "rgba(30, 30, 30, 0.9)",
              padding: "15px",
              overflowY: "auto",
              borderRight: "3px solid #333",
            }}
          >
            <div style={{ marginBottom: "20px" }}>
              <button
                onClick={goBack}
                style={{
                  background: "#666",
                  border: "none",
                  padding: "10px 15px",
                  borderRadius: "6px",
                  color: "white",
                  cursor: "pointer",
                  marginBottom: "15px",
                }}
              >
                â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ±Ø§Øª
              </button>
              <h2 style={{ margin: 0, color: "#ff5722" }}>ğŸ“‚ ÙØ¦Ø§Øª {currentServer?.name}</h2>
            </div>

            {categories.map((category) => (
              <div
                key={category.category_id}
                className="category"
                style={{
                  background: "#ff5722",
                  padding: "15px",
                  margin: "8px 0",
                  borderRadius: "8px",
                  textAlign: "center",
                  fontSize: "18px",
                  fontWeight: "bold",
                  cursor: "pointer",
                  transition: "0.3s",
                }}
                onClick={() => loadStreams(category)}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = "#e64a19"
                  e.currentTarget.style.transform = "scale(1.05)"
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = "#ff5722"
                  e.currentTarget.style.transform = "scale(1)"
                }}
              >
                {category.category_name}
              </div>
            ))}
          </div>

          <div
            style={{
              flex: 1,
              display: "grid",
              gridTemplateColumns: "repeat(5, 1fr)",
              gap: "12px",
              padding: "20px",
              overflowY: "auto",
              justifyContent: "center",
            }}
            id="content"
          >
            {loading && (
              <div
                style={{
                  gridColumn: "1 / -1",
                  textAlign: "center",
                  padding: "50px",
                  fontSize: "20px",
                }}
              >
                â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª...
              </div>
            )}
          </div>
        </div>
      )}

      {/* Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ù†ÙˆØ§Øª */}
      {currentView === "streams" && (
        <div style={{ display: "flex", height: "100vh" }}>
          <div
            style={{
              width: "300px",
              background: "rgba(30, 30, 30, 0.9)",
              padding: "15px",
              borderRight: "3px solid #333",
            }}
          >
            <button
              onClick={goBack}
              style={{
                background: "#666",
                border: "none",
                padding: "10px 15px",
                borderRadius: "6px",
                color: "white",
                cursor: "pointer",
                marginBottom: "15px",
              }}
            >
              â† Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙØ¦Ø§Øª
            </button>
            <h2 style={{ margin: 0, color: "#ff5722" }}>ğŸ“º {selectedCategory?.category_name}</h2>
            <p style={{ fontSize: "14px", opacity: 0.8, margin: "10px 0" }}>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª: {streams.length}</p>
          </div>

          <div
            style={{
              flex: 1,
              display: "grid",
              gridTemplateColumns: "repeat(5, 1fr)",
              gap: "12px",
              padding: "20px",
              overflowY: "auto",
            }}
          >
            {streams.map((stream) => (
              <div
                key={stream.stream_id}
                className="item"
                style={{
                  background: "rgba(255, 255, 255, 0.1)",
                  width: "100%",
                  height: "180px",
                  borderRadius: "12px",
                  display: "flex",
                  flexDirection: "column",
                  alignItems: "center",
                  justifyContent: "center",
                  cursor: "pointer",
                  transition: "0.3s",
                  padding: "10px",
                }}
                onClick={() => playStream(stream.stream_id)}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = "rgba(255, 255, 255, 0.2)"
                  e.currentTarget.style.transform = "scale(1.05)"
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = "rgba(255, 255, 255, 0.1)"
                  e.currentTarget.style.transform = "scale(1)"
                }}
              >
                <img
                  src={stream.stream_icon || "https://via.placeholder.com/100"}
                  alt="Logo"
                  style={{
                    width: "80%",
                    height: "70%",
                    objectFit: "contain",
                    borderRadius: "8px",
                  }}
                />
                <div
                  style={{
                    fontSize: "12px",
                    textAlign: "center",
                    marginTop: "8px",
                    wordBreak: "break-word",
                  }}
                >
                  {stream.name}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      <style jsx>{`
        @keyframes gradientAnimation {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
      `}</style>
    </div>
  )
}
